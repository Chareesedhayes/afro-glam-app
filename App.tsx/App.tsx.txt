import React, { useState, useRef, useEffect } from 'react';
import { 
  Sparkles, 
  ChevronRight, 
  Check, 
  Copy, 
  RefreshCw, 
  Wand2, 
  Heart, 
  Share2, 
  ArrowLeft,
  Crown,
  Palette,
  Camera,
  ShoppingBag,
  Zap,
  AlertCircle
} from 'lucide-react';
import { QUESTIONS, AppStep, CharacterOptions, GeneratedPrompts, ExtraType } from './types';
import { generateCharacterPrompts, generateExtraContent } from './services/geminiService';

// --- Types ---

interface ButtonProps {
  children?: React.ReactNode;
  onClick: () => void;
  variant?: 'primary' | 'secondary' | 'outline' | 'ghost';
  className?: string;
  disabled?: boolean;
  icon?: React.ElementType;
}

interface CardProps {
  children?: React.ReactNode;
  className?: string;
}

interface PromptCardProps {
  title: string;
  prompt: string;
  icon: React.ElementType;
}

// --- Components ---

const CPLogo: React.FC<{ className?: string }> = ({ className = "" }) => (
  <svg viewBox="0 0 200 200" className={className} xmlns="http://www.w3.org/2000/svg" aria-label="Afro-Glam Cartoon Creator Logo">
    <defs>
      <linearGradient id="logoGradient" x1="0%" y1="0%" x2="0%" y2="100%">
        <stop offset="0%" stopColor="#22d3ee" /> {/* Cyan-400 */}
        <stop offset="100%" stopColor="#1d4ed8" /> {/* Blue-700 */}
      </linearGradient>
      <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
        <feGaussianBlur stdDeviation="5" result="blur" />
        <feComposite in="SourceGraphic" in2="blur" operator="over" />
      </filter>
    </defs>
    
    <circle cx="100" cy="100" r="95" fill="url(#logoGradient)" stroke="white" strokeWidth="3" />
    
    <g style={{ fontFamily: '"Playfair Display", serif', fontWeight: 'bold' }}>
      <text x="75" y="135" fontSize="120" fill="white" textAnchor="middle">C</text>
      <text x="125" y="135" fontSize="120" fill="#cffafe" textAnchor="middle" opacity="0.9">P</text>
    </g>
    
    <text 
      x="170" 
      y="100" 
      fontSize="13" 
      fill="white" 
      fontFamily="sans-serif" 
      fontWeight="normal" 
      textAnchor="middle" 
      transform="rotate(90, 170, 100)"
      letterSpacing="2"
      opacity="0.95"
    >
      CHAREESE'S PIECES
    </text>
  </svg>
);

const Button: React.FC<ButtonProps> = ({ children, onClick, variant = 'primary', className = '', disabled = false, icon: Icon }) => {
  const baseStyle = "px-6 py-3 rounded-full font-medium transition-all duration-300 transform active:scale-95 flex items-center justify-center gap-2 shadow-md";
  const variants: Record<string, string> = {
    primary: "bg-gradient-to-r from-rose-400 to-pink-500 text-white hover:shadow-rose-300/50 hover:from-rose-500 hover:to-pink-600 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none disabled:transform-none",
    secondary: "bg-white text-rose-500 border-2 border-rose-100 hover:bg-rose-50 hover:border-rose-200 disabled:opacity-50 disabled:cursor-not-allowed",
    outline: "border border-white/40 text-rose-900 hover:bg-white/20 disabled:opacity-50",
    ghost: "text-rose-700 hover:bg-rose-100/50 shadow-none disabled:opacity-50"
  };

  return (
    <button 
      onClick={onClick} 
      disabled={disabled}
      className={`${baseStyle} ${variants[variant]} ${className}`}
    >
      {Icon && <Icon size={18} />}
      {children}
    </button>
  );
};

const Card: React.FC<CardProps> = ({ children, className = '' }) => (
  <div className={`bg-white/80 backdrop-blur-xl rounded-3xl shadow-xl border border-white/60 p-6 ${className}`}>
    {children}
  </div>
);

// --- Main App ---

export default function App() {
  // State
  const [step, setStep] = useState<AppStep>(AppStep.WELCOME);
  const [wizardIndex, setWizardIndex] = useState(0);
  const [formData, setFormData] = useState<CharacterOptions>({
    artStyle: '', skinTone: '', nationality: '', hairType: '', hairColor: '', outfit: '', 
    accessories: [], pose: '', vibe: '', background: '', usage: ''
  });
  const [prompts, setPrompts] = useState<GeneratedPrompts | null>(null);
  const [isProMode, setIsProMode] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [extraResult, setExtraResult] = useState<{title: string, content: string} | null>(null);
  // Track if user is explicitly in custom mode to prevent input from disappearing while typing
  const [customMode, setCustomMode] = useState(false);
  
  const scrollRef = useRef<HTMLDivElement>(null);

  // Effects
  useEffect(() => {
    // Reset custom mode when moving between questions
    setCustomMode(false);
    // Scroll to top of card/screen for better UX on mobile
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }, [wizardIndex, step]);

  // Handlers
  const handleStart = () => setStep(AppStep.WIZARD);

  const handleOptionSelect = (value: string) => {
    const currentQ = QUESTIONS[wizardIndex];
    
    if (currentQ.multi) {
      const currentArr = formData[currentQ.key as keyof CharacterOptions] as string[];
      const newArr = currentArr.includes(value) 
        ? currentArr.filter(i => i !== value)
        : [...currentArr, value];
        
      setFormData(prev => ({ ...prev, [currentQ.key]: newArr }));
    } else {
      if (value === 'Custom') {
        setCustomMode(true);
        // Initialize with 'Custom' so it's not empty in state (logic will render empty input)
        setFormData(prev => ({ ...prev, [currentQ.key]: 'Custom' }));
      } else {
        setCustomMode(false);
        setFormData(prev => ({ ...prev, [currentQ.key]: value }));
        // Auto advance for single select if not custom
        setTimeout(nextQuestion, 300);
      }
    }
  };

  const handleCustomInput = (value: string) => {
    const currentQ = QUESTIONS[wizardIndex];
    if (currentQ.multi) return;
    setFormData(prev => ({ ...prev, [currentQ.key]: value }));
  };

  const nextQuestion = () => {
    if (wizardIndex < QUESTIONS.length - 1) {
      setWizardIndex(prev => prev + 1);
    } else {
      setStep(AppStep.SUMMARY);
    }
  };

  const prevQuestion = () => {
    if (wizardIndex > 0) {
      setWizardIndex(prev => prev - 1);
    } else {
      setStep(AppStep.WELCOME);
    }
  };

  const generate = async () => {
    setStep(AppStep.GENERATING);
    setIsLoading(true);
    setError(null);
    try {
      const result = await generateCharacterPrompts(formData, isProMode);
      setPrompts(result);
      setStep(AppStep.RESULTS);
    } catch (e: any) {
      console.error(e);
      if (e.message?.includes("API Key")) {
        setError("Missing API Key! Please set the API_KEY environment variable.");
      } else {
        setError("Oops! The glam magic hit a snag. Please try again, Queen! âœ¨");
      }
      setStep(AppStep.SUMMARY);
    } finally {
      setIsLoading(false);
    }
  };

  const handleExtra = async (type: ExtraType) => {
    if (!prompts) return;
    setExtraResult(null);
    setIsLoading(true);
    // Scroll to extra result area
    setTimeout(() => {
        scrollRef.current?.scrollIntoView({ behavior: 'smooth' });
    }, 100);

    try {
      const content = await generateExtraContent(formData, type, prompts);
      setExtraResult({ title: type.charAt(0).toUpperCase() + type.slice(1), content });
    } catch (e) {
      console.error(e);
    } finally {
      setIsLoading(false);
    }
  };

  const isNextDisabled = () => {
    const q = QUESTIONS[wizardIndex];
    const val = formData[q.key as keyof CharacterOptions];
    
    if (q.multi) {
      return (val as string[]).length === 0;
    }
    
    // Single select: invalid if empty, undefined, or just "Custom" placeholder without text
    if (!val) return true;
    if (val === 'Custom') return true; 
    return (val as string).trim().length === 0;
  };

  // --- Render Steps ---

  const renderWelcome = () => (
    <div className="flex flex-col items-center justify-center min-h-[80vh] text-center px-4 animate-in fade-in duration-700">
      <div className="mb-8 relative">
        <div className="absolute inset-0 bg-blue-400 blur-3xl opacity-20 rounded-full animate-pulse"></div>
        <div className="relative transition-transform hover:scale-105 duration-300">
           <CPLogo className="w-40 h-40 md:w-52 md:h-52 drop-shadow-2xl" />
        </div>
      </div>
      <h1 className="text-4xl md:text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-rose-500 to-purple-600 mb-2 drop-shadow-sm leading-tight">
        Afro-Glam Cartoon Creatorâ„¢
      </h1>
      <p className="text-sm md:text-base text-rose-500 font-semibold tracking-widest uppercase mb-8">
        by Chareeseâ€™s Pieces Digital
      </p>
      
      <p className="text-lg md:text-xl text-slate-600 max-w-2xl mb-8 leading-relaxed">
        Your glamorous AI assistant for creating melanin-rich characters and digital assets. 
        Let's create something magical, Sis! âœ¨
      </p>
      
      <div className="flex flex-col sm:flex-row gap-4">
        <Button onClick={handleStart} icon={Sparkles} className="text-lg px-8">
          Start Creating
        </Button>
        <div className="flex items-center gap-2 px-6 py-3 bg-white/50 rounded-full border border-rose-200">
          <span className="text-sm font-semibold text-rose-700">Pro Mode</span>
          <button 
            onClick={() => setIsProMode(!isProMode)}
            className={`w-12 h-6 rounded-full p-1 transition-colors duration-300 ${isProMode ? 'bg-rose-500' : 'bg-slate-300'}`}
            aria-label="Toggle Pro Mode"
          >
            <div className={`w-4 h-4 bg-white rounded-full shadow-md transform transition-transform duration-300 ${isProMode ? 'translate-x-6' : 'translate-x-0'}`} />
          </button>
        </div>
      </div>
    </div>
  );

  const renderWizard = () => {
    const q = QUESTIONS[wizardIndex];
    const currentVal = formData[q.key as keyof CharacterOptions];
    
    // Determine if we should show the custom input UI
    const isCustomActive = !q.multi && (
        customMode || 
        (currentVal === 'Custom') || 
        (!q.options.includes(currentVal as string) && currentVal !== '')
    );

    return (
      <div className="max-w-2xl mx-auto pt-10 px-4">
        <div className="flex items-center justify-between mb-8">
          <div className="flex items-center gap-3">
            <button 
              onClick={prevQuestion} 
              className="text-rose-400 hover:text-rose-600 transition-colors hover:bg-rose-50 p-2 rounded-full -ml-2"
              aria-label="Previous question"
            >
              <ArrowLeft size={24} />
            </button>
            <div className="hidden sm:block">
              <CPLogo className="w-10 h-10 shadow-md rounded-full" />
            </div>
          </div>
          
          <div className="flex gap-1">
            {QUESTIONS.map((_, idx) => (
              <div key={idx} className={`h-1.5 rounded-full transition-all duration-300 ${idx <= wizardIndex ? 'w-6 bg-rose-400' : 'w-2 bg-rose-100'}`} />
            ))}
          </div>
          <span className="text-xs font-semibold text-rose-300">
            {wizardIndex + 1}/{QUESTIONS.length}
          </span>
        </div>

        <Card className="min-h-[400px] flex flex-col justify-between">
          <div key={wizardIndex} className="animate-in fade-in slide-in-from-bottom-4 duration-500">
            <h2 className="text-2xl md:text-3xl font-bold text-slate-800 mb-6 flex items-center gap-2">
              {q.question} 
              <span className="text-rose-400 animate-pulse">âœ¨</span>
            </h2>
            
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-6">
              {q.options.map((opt) => {
                let isSelected = false;
                
                if (q.multi) {
                  isSelected = (currentVal as string[]).includes(opt);
                } else {
                  if (opt === 'Custom') {
                    isSelected = isCustomActive;
                  } else {
                    isSelected = !isCustomActive && currentVal === opt;
                  }
                }
                  
                return (
                  <button
                    key={opt}
                    onClick={() => handleOptionSelect(opt)}
                    className={`
                      px-4 py-3 rounded-xl text-left font-medium transition-all duration-200
                      flex items-center justify-between group
                      ${isSelected 
                        ? 'bg-rose-500 text-white shadow-lg shadow-rose-200 ring-2 ring-rose-300 ring-offset-2' 
                        : 'bg-rose-50 text-slate-600 hover:bg-rose-100 hover:translate-x-1'
                      }
                    `}
                  >
                    {opt}
                    {isSelected && <Check size={18} className="text-white" />}
                  </button>
                );
              })}
            </div>

            {/* Custom Input Field - Only for single select */}
            {isCustomActive && (
              <div className="mt-4 animate-in fade-in slide-in-from-top-2">
                  <input 
                      type="text" 
                      autoFocus
                      placeholder="Type your custom detail..."
                      className="w-full px-4 py-3 rounded-xl bg-slate-50 border-2 border-slate-100 focus:border-rose-300 focus:ring-rose-200 focus:outline-none transition-all text-slate-800 placeholder-slate-400"
                      value={currentVal === 'Custom' ? '' : currentVal as string}
                      onChange={(e) => handleCustomInput(e.target.value)} 
                  />
              </div>
            )}
          </div>

          <div className="flex justify-end pt-6 border-t border-slate-100">
             <Button 
               onClick={nextQuestion} 
               icon={ChevronRight}
               disabled={isNextDisabled()}
             >
               {wizardIndex === QUESTIONS.length - 1 ? 'Review' : 'Next'}
             </Button>
          </div>
        </Card>
      </div>
    );
  };

  const renderSummary = () => (
    <div className="max-w-3xl mx-auto pt-10 px-4 pb-20 animate-in fade-in duration-500">
      <h2 className="text-3xl font-bold text-center mb-2 text-slate-800">Review Your Vision</h2>
      <p className="text-center text-slate-500 mb-8">Does everything look perfect, Queen?</p>
      
      {error && (
        <div className="mb-8 p-4 bg-rose-100 border border-rose-200 rounded-xl text-rose-800 flex items-center gap-3 animate-in shake">
          <AlertCircle className="shrink-0" />
          <p>{error}</p>
        </div>
      )}

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
        {Object.entries(formData).map(([key, value]) => {
          const label = QUESTIONS.find(q => q.key === key)?.question.replace('Choose your ', '').replace('Select the ', '').replace('What\'s the ', '').replace('?', '') || key;
          return (
            <Card key={key} className="p-4 !rounded-xl !bg-white/60">
              <h3 className="text-xs font-bold text-rose-400 uppercase tracking-wider mb-1">{label}</h3>
              <p className="text-slate-800 font-medium">
                {Array.isArray(value) ? value.join(', ') || 'None' : value || 'None'}
              </p>
            </Card>
          )
        })}
      </div>

      <div className="flex gap-4 justify-center">
        <Button variant="secondary" onClick={() => setStep(AppStep.WIZARD)}>Make Changes</Button>
        <Button onClick={generate} icon={Wand2} className="px-10">Generate Magic</Button>
      </div>
    </div>
  );

  const renderLoading = () => (
    <div className="flex flex-col items-center justify-center min-h-[60vh] animate-in fade-in duration-500">
      <div className="relative">
        {/* Animated CPLogo for loading */}
        <div className="relative w-28 h-28 animate-pulse">
           <CPLogo className="w-full h-full drop-shadow-xl" />
           <div className="absolute inset-0 border-4 border-rose-200 border-t-rose-500 rounded-full animate-spin"></div>
        </div>
      </div>
      <h2 className="text-2xl font-bold mt-8 text-slate-700">Brewing your glam assets...</h2>
      <p className="text-rose-400 mt-2 animate-pulse">Sprinkling some melanin magic âœ¨</p>
    </div>
  );

  const PromptCard = ({ title, prompt, icon: Icon }: PromptCardProps) => {
    const [copied, setCopied] = useState(false);
    const copyToClipboard = () => {
      navigator.clipboard.writeText(prompt);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    };

    return (
      <div className="bg-white rounded-2xl p-5 shadow-lg border border-rose-100 hover:shadow-xl transition-shadow group">
        <div className="flex justify-between items-center mb-3">
          <div className="flex items-center gap-2">
            <div className="p-2 bg-rose-100 rounded-lg text-rose-600 group-hover:bg-rose-500 group-hover:text-white transition-colors">
              <Icon size={18} />
            </div>
            <h3 className="font-bold text-slate-700">{title}</h3>
          </div>
          <button 
            onClick={copyToClipboard}
            className="text-slate-400 hover:text-rose-500 transition-colors"
            title="Copy prompt"
            aria-label={`Copy ${title} prompt`}
          >
            {copied ? <Check size={18} /> : <Copy size={18} />}
          </button>
        </div>
        <div className="bg-slate-50 p-3 rounded-xl text-sm text-slate-600 leading-relaxed font-mono max-h-32 overflow-y-auto glam-scroll border border-slate-100 whitespace-pre-wrap break-words">
          {prompt}
        </div>
      </div>
    );
  };

  const renderResults = () => {
    if (!prompts) return null;

    return (
      <div className="max-w-5xl mx-auto pt-6 px-4 pb-20">
        <div className="text-center mb-10 animate-in fade-in slide-in-from-bottom-4 duration-700">
          <span className="inline-block px-4 py-1 bg-green-100 text-green-700 rounded-full text-sm font-bold mb-4 tracking-wide">
            âœ¨ GENERATION COMPLETE
          </span>
          <h2 className="text-3xl md:text-4xl font-bold text-slate-800 mb-2">Your Glam Assets Are Ready!</h2>
          <p className="text-slate-500">Copy these prompts into your favorite AI tools.</p>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12 animate-in slide-in-from-bottom-8 fade-in duration-700 delay-100">
          <PromptCard title="Midjourney" prompt={prompts.midjourney} icon={Palette} />
          <PromptCard title="DALLÂ·E 3" prompt={prompts.dalle} icon={Camera} />
          <PromptCard title="Universal" prompt={prompts.universal} icon={Share2} />
          <PromptCard title="Microsoft Designer" prompt={prompts.microsoft} icon={Zap} />
          <PromptCard title="Envato Elements" prompt={prompts.envato} icon={ShoppingBag} />
          <PromptCard title="Video Script" prompt={prompts.whiskScript} icon={Heart} />
        </div>

        {/* Extras Section */}
        <div className="bg-white/60 backdrop-blur-md rounded-3xl p-8 border border-white shadow-xl animate-in slide-in-from-bottom-12 fade-in duration-1000 delay-200">
          <h3 className="text-2xl font-bold text-center mb-2">Want some extras, Queen? ðŸ‘‘</h3>
          <p className="text-center text-slate-500 mb-8">Tap below to generate bonus content instantly.</p>
          
          <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
             {[
               { id: 'bestie', label: 'Bestie Version', icon: Heart },
               { id: 'stickers', label: 'Sticker Sheet', icon: Sparkles },
               { id: 'coloring', label: 'Coloring Page', icon: Palette },
               { id: 'names', label: 'Name Ideas', icon: Crown },
               { id: 'listing', label: 'Etsy Listing', icon: ShoppingBag },
               { id: 'thumbnail', label: 'Thumbnail Idea', icon: Camera },
               { id: 'tiktok', label: 'TikTok Script', icon: Share2 },
               { id: 'mockups', label: 'Mockup Ideas', icon: Palette },
               { id: 'captions', label: 'Social Captions', icon: Heart },
               { id: 'bundle', label: 'Bundle Concept', icon: ShoppingBag },
               { id: 'hashtags', label: 'Hashtag Set', icon: Crown },
               { id: 'carousel', label: 'Carousel Set', icon: Copy },
             ].map((item) => {
               const Icon = item.icon;
               return (
               <button
                key={item.id}
                disabled={isLoading}
                onClick={() => handleExtra(item.id as ExtraType)}
                className="flex flex-col items-center justify-center gap-2 p-4 bg-white rounded-xl shadow-sm hover:shadow-md hover:bg-rose-50 border border-slate-100 transition-all text-sm font-medium text-slate-700 disabled:opacity-50 group"
               >
                 <Icon size={20} className="text-rose-400 group-hover:scale-110 transition-transform" />
                 {item.label}
               </button>
             )})}
          </div>

          {/* Extra Result Display */}
          <div ref={scrollRef}>
            {isLoading && extraResult === null && (
                <div className="text-center py-8">
                    <RefreshCw className="animate-spin inline-block text-rose-500 mb-2" />
                    <p className="text-rose-500 font-medium">Creating extra magic...</p>
                </div>
            )}

            {extraResult && (
                <div className="mt-8 bg-gradient-to-br from-rose-50 to-purple-50 rounded-2xl p-6 border border-rose-100 animate-in fade-in zoom-in duration-300">
                    <div className="flex justify-between items-center mb-4">
                        <h4 className="text-lg font-bold text-rose-800">{extraResult.title}</h4>
                        <button 
                            onClick={() => {navigator.clipboard.writeText(extraResult.content)}}
                            className="text-rose-400 hover:text-rose-600 flex items-center gap-1 text-sm font-semibold"
                        >
                            <Copy size={16} /> Copy
                        </button>
                    </div>
                    <div className="prose prose-rose max-w-none text-slate-700 whitespace-pre-wrap font-sans text-sm">
                        {extraResult.content}
                    </div>
                </div>
            )}
          </div>
        </div>

        <div className="flex justify-center mt-12 mb-8">
          <Button variant="outline" onClick={() => {
              setStep(AppStep.WELCOME);
              setFormData({
                artStyle: '', skinTone: '', nationality: '', hairType: '', hairColor: '', outfit: '', 
                accessories: [], pose: '', vibe: '', background: '', usage: ''
              });
              setPrompts(null);
              setExtraResult(null);
              setWizardIndex(0);
          }}>
            Start New Character
          </Button>
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen">
       {/* Background decorative elements */}
       <div className="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
          <div className="absolute top-[-10%] right-[-5%] w-[500px] h-[500px] bg-indigo-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob"></div>
          <div className="absolute bottom-[-10%] left-[-10%] w-[500px] h-[500px] bg-rose-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000"></div>
          <div className="absolute top-[40%] left-[30%] w-[400px] h-[400px] bg-pink-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-4000"></div>
       </div>

      {step === AppStep.WELCOME && renderWelcome()}
      {step === AppStep.WIZARD && renderWizard()}
      {step === AppStep.SUMMARY && renderSummary()}
      {step === AppStep.GENERATING && renderLoading()}
      {step === AppStep.RESULTS && renderResults()}
      
      <div className="fixed bottom-4 right-4 text-xs text-slate-400 bg-white/50 backdrop-blur px-3 py-1 rounded-full">
         Powered by Gemini â€¢ Chareeseâ€™s Pieces Digital Style
      </div>
    </div>
  );
}