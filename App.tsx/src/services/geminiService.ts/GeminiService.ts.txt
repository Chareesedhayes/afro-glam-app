import { GoogleGenAI, Type, Schema } from "@google/genai";
import { CharacterOptions, GeneratedPrompts, ExtraType } from '../types';

// FIX: Declare process to avoid TypeScript error during build
declare const process: any;

const getClient = () => {
  const apiKey = process.env.API_KEY;
  if (!apiKey) throw new Error("API Key not found");
  return new GoogleGenAI({ apiKey });
};

const SYSTEM_INSTRUCTION = `
You are the Afro-Glam Cartoon Creator‚Ñ¢ by Chareese‚Äôs Pieces Digital ‚Äî a glamorous, step-by-step AI assistant.

YOUR PERSONALITY:
- Warm, glam, encouraging, soft-life energy.
- Clear, structured, and beginner-friendly.
- Always celebrate the user‚Äôs creativity.
- Use emojis like ‚ú®, üíñ, üëë, üíÖüèΩ.

RULES:
- Never mention you are a large language model.
- Always produce commercial-ready results.
- Always default to melanin-inclusive character options.
- Always write in Chareese‚Äôs Pieces Digital brand tones.
`;

export const generateCharacterPrompts = async (options: CharacterOptions, isPro: boolean): Promise<GeneratedPrompts> => {
  const ai = getClient();
  
  const proInstruction = isPro 
    ? "The user is in PRO MODE. Ensure prompts are highly detailed, technical, and optimized for high-fidelity generation." 
    : "Keep prompts clear, effective, and beginner-friendly.";

  const promptText = `
    Based on the following user inputs, generate 6 specific AI image generation prompts.
    
    User Inputs:
    ${JSON.stringify(options, null, 2)}

    ${proInstruction}

    Please output strictly valid JSON.
  `;

  const schema: Schema = {
    type: Type.OBJECT,
    properties: {
      midjourney: { type: Type.STRING, description: "Midjourney specific prompt, including aspect ratios if relevant" },
      dalle: { type: Type.STRING, description: "DALL-E 3 specific prompt" },
      universal: { type: Type.STRING, description: "Universal prompt for Canva, Leonardo, etc." },
      microsoft: { type: Type.STRING, description: "Microsoft Designer prompt" },
      envato: { type: Type.STRING, description: "Envato Elements prompt" },
      whiskScript: { type: Type.STRING, description: "Short video script for TikTok/Reels describing the character creation" },
    },
    required: ["midjourney", "dalle", "universal", "microsoft", "envato", "whiskScript"],
  };

  const response = await ai.models.generateContent({
    model: 'gemini-2.5-flash',
    contents: promptText,
    config: {
      systemInstruction: SYSTEM_INSTRUCTION,
      responseMimeType: "application/json",
      responseSchema: schema
    }
  });

  if (!response.text) throw new Error("No response from AI");
  
  return JSON.parse(response.text) as GeneratedPrompts;
};

export const generateExtraContent = async (
  options: CharacterOptions, 
  extraType: ExtraType, 
  currentPrompts: GeneratedPrompts
): Promise<string> => {
  const ai = getClient();

  let request = "";
  switch(extraType) {
    case 'bestie': request = "Generate a matching 'Bestie' character prompt description."; break;
    case 'stickers': request = "Generate a prompt for a 5-pose sticker sheet based on this character."; break;
    case 'coloring': request = "Generate a prompt for a black and white coloring page version."; break;
    case 'names': request = "Suggest 10 creative names for this character/pack."; break;
    case 'listing': request = "Write an Etsy/Shopify listing description including title, tags, and body."; break;
    case 'thumbnail': request = "Describe a click-worthy thumbnail design for this asset."; break;
    case 'tiktok': request = "Write a viral TikTok/Reels script to promote this character."; break;
    case 'mockups': request = "List 5 mockup ideas to showcase this design."; break;
    case 'captions': request = "Write 5 engaging social media captions for this character."; break;
    case 'bundle': request = "Suggest 3 bundle concepts that include this character."; break;
    case 'hashtags': request = "Generate 30 relevant hashtags for Instagram and TikTok."; break;
    case 'carousel': request = "Outline a 5-slide educational carousel teaching how this character was made."; break;
  }

  const promptText = `
    Context - Original Character: ${JSON.stringify(options)}
    Context - Original Prompt (Midjourney): ${currentPrompts.midjourney}
    
    Task: ${request}
    
    Keep the tone Warm, Glam, and Encouraging. Use emojis. Format with Markdown.
  `;

  const response = await ai.models.generateContent({
    model: 'gemini-2.5-flash',
    contents: promptText,
    config: {
      systemInstruction: SYSTEM_INSTRUCTION,
    }
  });

  return response.text || "Could not generate content.";